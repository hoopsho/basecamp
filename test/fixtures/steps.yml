# frozen_string_literal: true

# Step fixtures define individual actions within SOPs

# Steps for Past Customer Reactivation SOP
pcr_step_1:
  id: <%= SecureRandom.uuid %>
  sop: past_customer_reactivation
  position: 1
  name: 'Query CRM for inactive customers'
  description: 'Query the CRM to find customers who have not booked services in 12+ months but have lifetime value over $500.'
  step_type: query
  config:
    query_type: 'crm_query'
    filters:
      last_booking_date: '< 365 days ago'
      lifetime_value: '> 500'
      status: 'inactive'
    output_format: 'customer_list'
  llm_tier: 0
  max_llm_tier: 0
  on_success: '2'
  on_failure: 'fail'
  on_uncertain: 'escalate'
  max_retries: 3
  timeout_seconds: 30
  created_at: <%= Time.current - 6.months %>
  updated_at: <%= Time.current %>

pcr_step_2:
  id: <%= SecureRandom.uuid %>
  sop: past_customer_reactivation
  position: 2
  name: 'Classify customer priority'
  description: 'Analyze each inactive customer and classify by reactivation potential based on service history, property type, and previous engagement.'
  step_type: llm_classify
  config:
    prompt: 'Classify this customer into high/medium/low priority for reactivation. Consider: {{customer_service_history}}, {{customer_property_type}}, {{customer_previous_response_rate}}. Return JSON with priority and reasoning.'
    categories:
      - high
      - medium
      - low
    confidence_threshold: 0.75
  llm_tier: 1
  max_llm_tier: 3
  on_success: '3'
  on_failure: 'escalate'
  on_uncertain: 'escalate_tier'
  max_retries: 3
  timeout_seconds: 45
  created_at: <%= Time.current - 6.months %>
  updated_at: <%= Time.current %>

pcr_step_3:
  id: <%= SecureRandom.uuid %>
  sop: past_customer_reactivation
  position: 3
  name: 'Draft personalized reactivation email'
  description: 'Draft a personalized email for high and medium priority customers referencing their specific service history and offering a compelling return incentive.'
  step_type: llm_draft
  config:
    prompt: 'Draft a warm, personalized email to {{customer_name}} who last booked {{last_service_type}} on {{last_booking_date}}. Reference their property type ({{property_type}}) and offer a 15% discount for reactivation. Tone: friendly, not pushy, professional.'
    output_format: 'email'
    include_subject: true
    tone: 'friendly_professional'
  llm_tier: 2
  max_llm_tier: 3
  on_success: '4'
  on_failure: 'escalate'
  on_uncertain: 'escalate_tier'
  max_retries: 2
  timeout_seconds: 60
  created_at: <%= Time.current - 6.months %>
  updated_at: <%= Time.current %>

pcr_step_4:
  id: <%= SecureRandom.uuid %>
  sop: past_customer_reactivation
  position: 4
  name: 'Send email via CRM'
  description: 'Send the drafted email through the CRM integration and log the outreach.'
  step_type: api_call
  config:
    service: 'crm'
    action: 'send_email'
    template: 'reactivation_outreach'
    log_to_crm: true
  llm_tier: 0
  max_llm_tier: 0
  on_success: '5'
  on_failure: 'retry'
  on_uncertain: 'escalate'
  max_retries: 3
  timeout_seconds: 30
  created_at: <%= Time.current - 6.months %>
  updated_at: <%= Time.current %>

pcr_step_5:
  id: <%= SecureRandom.uuid %>
  sop: past_customer_reactivation
  position: 5
  name: 'Schedule follow-up reminder'
  description: 'Create a follow-up task for customers who do not respond within 7 days.'
  step_type: enqueue_next
  config:
    sop_to_trigger: 'follow_up_nurture'
    delay_hours: 168
    condition: 'no_response'
  llm_tier: 0
  max_llm_tier: 0
  on_success: 'complete'
  on_failure: 'complete'
  on_uncertain: 'complete'
  max_retries: 1
  timeout_seconds: 15
  created_at: <%= Time.current - 6.months %>
  updated_at: <%= Time.current %>

# Steps for New Lead Response SOP
nlr_step_1:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 1
  name: 'Query lead details from CRM'
  description: 'Fetch lead details from CRM including source, contact info, and initial inquiry data.'
  step_type: query
  config:
    query_type: 'crm_query'
    object: 'lead'
    fields:
      - name
      - email
      - phone
      - source
      - inquiry_details
  llm_tier: 0
  max_llm_tier: 0
  on_success: '2'
  on_failure: 'fail'
  on_uncertain: 'escalate'
  max_retries: 3
  timeout_seconds: 15
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

nlr_step_2:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 2
  name: 'Classify lead quality'
  description: 'Analyze lead details and classify as hot, warm, or cold based on urgency, property fit, and service match.'
  step_type: llm_classify
  config:
    prompt: 'Classify this lead: {{lead_inquiry_details}}. Source: {{lead_source}}. Return JSON with classification and reasoning.'
    categories:
      - hot
      - warm
      - cold
    confidence_threshold: 0.7
  llm_tier: 1
  max_llm_tier: 2
  on_success: '3'
  on_failure: 'escalate'
  on_uncertain: 'escalate_tier'
  max_retries: 2
  timeout_seconds: 30
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

nlr_step_3:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 3
  name: 'Draft personalized response'
  description: 'Draft a tailored email response based on lead classification and inquiry details.'
  step_type: llm_draft
  config:
    prompt: 'Draft a response to {{lead_name}} about {{service_type}}. Lead is classified as {{lead_quality}}. Include: availability estimate, next steps, and invitation to schedule consultation.'
    output_format: 'email'
    include_subject: true
  llm_tier: 2
  max_llm_tier: 2
  on_success: '4'
  on_failure: 'escalate'
  on_uncertain: 'escalate'
  max_retries: 2
  timeout_seconds: 45
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

nlr_step_4:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 4
  name: 'Post to Slack for approval'
  description: 'Post the drafted response to Slack for human review before sending.'
  step_type: slack_ask_human
  config:
    channel: '#lead-response'
    message_template: 'New lead response ready for review for {{lead_name}} ({{lead_email}}). Quality: {{lead_quality}}'
    timeout_hours: 2
    auto_approve: false
  llm_tier: 0
  max_llm_tier: 0
  on_success: '5'
  on_failure: 'escalate'
  on_uncertain: 'escalate'
  max_retries: 1
  timeout_seconds: 7200
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

nlr_step_5:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 5
  name: 'Send approved response'
  description: 'Send the human-approved email response via CRM.'
  step_type: api_call
  config:
    service: 'crm'
    action: 'send_email'
    template: 'lead_response'
  llm_tier: 0
  max_llm_tier: 0
  on_success: '6'
  on_failure: 'retry'
  on_uncertain: 'escalate'
  max_retries: 3
  timeout_seconds: 30
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

nlr_step_6:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 6
  name: 'Notify team of new lead'
  description: 'Post notification to team Slack channel about the new lead.'
  step_type: slack_notify
  config:
    channel: '#operations'
    message_template: 'New {{lead_quality}} lead: {{lead_name}} - {{service_type}}. Response sent.'
  llm_tier: 0
  max_llm_tier: 0
  on_success: '7'
  on_failure: 'complete'
  on_uncertain: 'complete'
  max_retries: 2
  timeout_seconds: 15
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

nlr_step_7:
  id: <%= SecureRandom.uuid %>
  sop: new_lead_response
  position: 7
  name: 'Schedule follow-up'
  description: 'Schedule a follow-up task in the CRM for 48 hours if lead is hot or warm.'
  step_type: wait
  config:
    duration_hours: 48
    condition: "lead_quality IN ['hot', 'warm']"
  llm_tier: 0
  max_llm_tier: 0
  on_success: 'complete'
  on_failure: 'complete'
  on_uncertain: 'complete'
  max_retries: 1
  timeout_seconds: 172800
  created_at: <%= Time.current - 4.months %>
  updated_at: <%= Time.current %>

# Steps for AR Follow-up SOP
ar_step_1:
  id: <%= SecureRandom.uuid %>
  sop: ar_followup
  position: 1
  name: 'Query past due invoices'
  description: 'Query CRM for invoices past due by 30, 45, or 60+ days.'
  step_type: query
  config:
    query_type: 'crm_query'
    object: 'invoice'
    filters:
      status: 'overdue'
      days_overdue: '> 30'
  llm_tier: 0
  max_llm_tier: 0
  on_success: '2'
  on_failure: 'fail'
  on_uncertain: 'escalate'
  max_retries: 3
  timeout_seconds: 30
  created_at: <%= Time.current - 2.months %>
  updated_at: <%= Time.current %>

ar_step_2:
  id: <%= SecureRandom.uuid %>
  sop: ar_followup
  position: 2
  name: 'Analyze customer payment history'
  description: 'Analyze payment patterns to determine appropriate escalation level.'
  step_type: llm_analyze
  config:
    prompt: 'Analyze payment history for {{customer_name}}. Invoices: {{invoice_history}}, Average payment time: {{avg_days_to_pay}}. Recommend tone: gentle/firm/urgent. Return JSON with recommendation and reasoning.'
    output_format: 'json'
  llm_tier: 1
  max_llm_tier: 2
  on_success: '3'
  on_failure: 'escalate'
  on_uncertain: 'escalate_tier'
  max_retries: 2
  timeout_seconds: 45
  created_at: <%= Time.current - 2.months %>
  updated_at: <%= Time.current %>

ar_step_3:
  id: <%= SecureRandom.uuid %>
  sop: ar_followup
  position: 3
  name: 'Draft payment reminder'
  description: 'Draft a payment reminder email with appropriate tone based on analysis.'
  step_type: llm_draft
  config:
    prompt: 'Draft a {{tone}} payment reminder for {{customer_name}}. Invoice {{invoice_number}} for {{invoice_amount}} is {{days_overdue}} days overdue. Include payment options and contact info.'
    output_format: 'email'
    include_subject: true
  llm_tier: 1
  max_llm_tier: 2
  on_success: '4'
  on_failure: 'escalate'
  on_uncertain: 'escalate_tier'
  max_retries: 2
  timeout_seconds: 30
  created_at: <%= Time.current - 2.months %>
  updated_at: <%= Time.current %>

ar_step_4:
  id: <%= SecureRandom.uuid %>
  sop: ar_followup
  position: 4
  name: 'Escalate if high priority'
  description: 'For urgent cases (60+ days or VIP customer), escalate to team lead for approval.'
  step_type: slack_ask_human
  config:
    channel: '#ar-followup'
    message_template: 'AR escalation needed for {{customer_name}}. {{days_overdue}} days overdue. Amount: {{invoice_amount}}. Draft ready for review.'
    timeout_hours: 24
    condition: 'days_overdue >= 60 OR customer_tier == vip'
  llm_tier: 0
  max_llm_tier: 0
  on_success: '5'
  on_failure: 'escalate'
  on_uncertain: 'escalate'
  max_retries: 1
  timeout_seconds: 86400
  created_at: <%= Time.current - 2.months %>
  updated_at: <%= Time.current %>

ar_step_5:
  id: <%= SecureRandom.uuid %>
  sop: ar_followup
  position: 5
  name: 'Send reminder email'
  description: 'Send the payment reminder via email through CRM.'
  step_type: api_call
  config:
    service: 'crm'
    action: 'send_email'
    template: 'payment_reminder'
    cc: 'ar@snowmass.example.com'
  llm_tier: 0
  max_llm_tier: 0
  on_success: 'complete'
  on_failure: 'retry'
  on_uncertain: 'escalate'
  max_retries: 3
  timeout_seconds: 30
  created_at: <%= Time.current - 2.months %>
  updated_at: <%= Time.current %>
