<%= form_with model: [:admin, @sop, @step], class: "space-y-6" do |f| %>
  <% if @step.errors.any? %>
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-red-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <div>
          <h3 class="text-sm font-medium text-red-800 dark:text-red-200">
            <%= pluralize(@step.errors.count, "error") %> prohibited this step from being saved:
          </h3>
          <ul class="mt-2 text-sm text-red-700 dark:text-red-300 list-disc list-inside">
            <% @step.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 space-y-6">
    <%# Basic Information %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= f.label :position, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.number_field :position, min: 0,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent",
            placeholder: "0" %>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Position in the SOP sequence (0-based).</p>
      </div>

      <div>
        <%= f.label :step_type, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.select :step_type,
            Step.step_types.keys.map { |k| [k.humanize, k] },
            {},
            { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" } %>
      </div>

      <div class="md:col-span-2">
        <%= f.label :name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.text_field :name,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
            placeholder: "e.g., Classify incoming email" %>
      </div>

      <div class="md:col-span-2">
        <%= f.label :description, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.text_area :description, rows: 2,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
            placeholder: "Describe what this step does..." %>
      </div>
    </div>

    <%# LLM Configuration %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6" data-controller="conditional-field" data-conditional-field-when-value="llm_classify,llm_draft,llm_decide,llm_analyze">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">LLM Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :llm_tier, "Minimum LLM Tier", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :llm_tier,
              [['Tier 0 - No LLM', 0], ['Tier 1 - Haiku', 1], ['Tier 2 - Sonnet', 2], ['Tier 3 - Opus', 3]],
              {},
              { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" } %>
        </div>

        <div>
          <%= f.label :max_llm_tier, "Maximum LLM Tier", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :max_llm_tier,
              [['Tier 0 - No LLM', 0], ['Tier 1 - Haiku', 1], ['Tier 2 - Sonnet', 2], ['Tier 3 - Opus', 3]],
              {},
              { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" } %>
        </div>
      </div>
    </div>

    <%# Step Transitions %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Step Transitions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Define what happens after this step completes, fails, or is uncertain.</p>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <%= f.label :on_success, "On Success", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :on_success,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
              placeholder: "e.g., 2 or complete" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Next step position, or "complete"</p>
        </div>

        <div>
          <%= f.label :on_failure, "On Failure", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :on_failure,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
              placeholder: "e.g., retry, escalate, fail, or position" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">retry, escalate, fail, or step position</p>
        </div>

        <div>
          <%= f.label :on_uncertain, "On Uncertain", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :on_uncertain,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
              placeholder: "e.g., escalate_tier or position" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">escalate_tier or step position</p>
        </div>
      </div>
    </div>

    <%# Retry Configuration %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Retry Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :max_retries, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.number_field :max_retries, min: 0, max: 10,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Maximum number of retry attempts (0-10).</p>
        </div>

        <div>
          <%= f.label :timeout_seconds, "Timeout (seconds)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.number_field :timeout_seconds, min: 1,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
              placeholder: "300" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How long before step is considered hung.</p>
        </div>
      </div>
    </div>

    <%# Step Configuration (JSON) %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Step Configuration</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">JSON configuration specific to this step type (prompt templates, API params, etc.).</p>
      <div>
        <%= f.text_area :config, 
            value: @step.config.present? ? JSON.pretty_generate(@step.config) : '',
            rows: 10,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-gray-100 font-mono text-sm focus:ring-2 focus:ring-primary-500 focus:border-transparent",
            placeholder: "{\n  \"prompt_template\": \"Classify this email...\",\n  \"categories\": [\"new_lead\", \"existing_customer\", \"spam\"]\n}" %>
      </div>
      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Must be valid JSON. Use double quotes for keys and string values.</p>
    </div>

    <%# Step Type Help %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Step Type Reference</h3>
      <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 text-sm space-y-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">query</code> - CRM API query / check condition</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">api_call</code> - Call external API (email, CRM, etc.)</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_classify</code> - Classify input into categories</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_draft</code> - Draft text content (email, message)</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_decide</code> - Make a judgment call with reasoning</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_analyze</code> - Complex analysis of data/situation</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">slack_notify</code> - Post update to Slack channel</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">slack_ask_human</code> - Post to Slack and wait for response</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">enqueue_next</code> - Trigger another SOP or schedule follow-up</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">wait</code> - Pause for a duration before continuing</div>
        </div>
      </div>
    </div>
  </div>

  <%# Actions %>
  <div class="flex items-center justify-end gap-3">
    <%= link_to "Cancel", admin_sop_path(@sop),
        class: "px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 font-medium transition-colors" %>
    <%= f.submit @step.persisted? ? "Update Step" : "Create Step",
        class: "px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900" %>
  </div>
<% end %>
