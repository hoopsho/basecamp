<%= form_with model: @step, url: @step.persisted? ? admin_step_path(@step) : admin_sop_steps_path(@sop), class: "space-y-6" do |f| %>
  <% if @step.errors.any? %>
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-red-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <div>
          <h3 class="text-sm font-medium text-red-800 dark:text-red-200">
            <%= pluralize(@step.errors.count, "error") %> prohibited this step from being saved:
          </h3>
          <ul class="mt-2 text-sm text-red-700 dark:text-red-300 list-disc list-inside">
            <% @step.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 space-y-6">
    <%# Basic Information %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= f.label :position, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.number_field :position, min: 0,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent",
            placeholder: "0" %>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Position in the SOP sequence (0-based).</p>
      </div>

      <div>
        <%= f.label :step_type, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.select :step_type,
            Step.step_types.keys.map { |k| [k.humanize, k] },
            {},
            { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" } %>
      </div>

      <div class="md:col-span-2">
        <%= f.label :name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.text_field :name,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
            placeholder: "e.g., Classify incoming email" %>
      </div>

      <div class="md:col-span-2">
        <%= f.label :description, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.text_area :description, rows: 2,
            class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
            placeholder: "Describe what this step does..." %>
      </div>
    </div>

    <%# LLM Configuration %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6" data-controller="conditional-field" data-conditional-field-when-value="llm_classify,llm_draft,llm_decide,llm_analyze">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">LLM Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :llm_tier, "Minimum LLM Tier", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :llm_tier,
              [['Tier 0 - No LLM', 0], ['Tier 1 - Haiku', 1], ['Tier 2 - Sonnet', 2], ['Tier 3 - Opus', 3]],
              {},
              { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" } %>
        </div>

        <div>
          <%= f.label :max_llm_tier, "Maximum LLM Tier", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :max_llm_tier,
              [['Tier 0 - No LLM', 0], ['Tier 1 - Haiku', 1], ['Tier 2 - Sonnet', 2], ['Tier 3 - Opus', 3]],
              {},
              { class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" } %>
        </div>
      </div>
    </div>

    <%# Step Transitions %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Step Transitions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Define what happens after this step completes, fails, or is uncertain.</p>

      <%
        # Build step position options from sibling steps (excluding self)
        sibling_steps = @sop.steps.ordered.reject { |s| s.id == @step.id }
        step_position_options = sibling_steps.map { |s| ["Go to step #{s.position}: #{s.name}", s.position.to_s] }

        success_options = [
          ['Next step', 'next'],
          ['Complete task', 'complete']
        ] + step_position_options

        failure_options = [
          ['Retry current step', 'retry'],
          ['Escalate to human', 'escalate'],
          ['Escalate to higher LLM tier', 'escalate_tier'],
          ['Mark task as failed', 'fail']
        ] + step_position_options

        uncertain_options = [
          ['Escalate to higher LLM tier', 'escalate_tier'],
          ['Escalate to human', 'escalate'],
          ['Mark task as failed', 'fail']
        ] + step_position_options

        select_classes = "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      %>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <%= f.label :on_success, "On Success", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :on_success, success_options,
              { selected: @step.on_success },
              { class: select_classes } %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">What happens when this step succeeds.</p>
        </div>

        <div>
          <%= f.label :on_failure, "On Failure", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :on_failure, failure_options,
              { selected: @step.on_failure },
              { class: select_classes } %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">What happens when this step fails.</p>
        </div>

        <div>
          <%= f.label :on_uncertain, "On Uncertain", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :on_uncertain, uncertain_options,
              { selected: @step.on_uncertain },
              { class: select_classes } %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">What happens when the outcome is unclear.</p>
        </div>
      </div>
    </div>

    <%# Retry Configuration %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Retry Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :max_retries, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.number_field :max_retries, min: 0, max: 10,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Maximum number of retry attempts (0-10).</p>
        </div>

        <div>
          <%= f.label :timeout_seconds, "Timeout (seconds)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.number_field :timeout_seconds, min: 1,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
              placeholder: "300" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How long before step is considered hung.</p>
        </div>
      </div>
    </div>

    <%# Step Configuration — type-specific fields %>
    <%
      field_classes = "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500"
      mono_classes = "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-mono text-sm focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500"
    %>

    <%# LLM Steps: prompt_template %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="llm_classify,llm_draft,llm_decide,llm_analyze"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Prompt Configuration</h3>
      <div class="space-y-4">
        <div>
          <%= f.label :config_prompt_template, "Prompt Template", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_area :config_prompt_template, value: @step.config_prompt_template, rows: 8,
              class: mono_classes,
              placeholder: "Classify this email from {{customer_name}}...\n\nAvailable context: {{context}}" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Use <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">{{variable}}</code> for task context placeholders.</p>
        </div>

        <%# output_format — llm_draft only %>
        <div data-controller="conditional-field"
             data-conditional-field-when-value="llm_draft"
             data-conditional-field-selector-value="select[name='step[step_type]']">
          <%= f.label :config_output_format, "Output Format", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_output_format, value: @step.config_output_format,
              class: field_classes,
              placeholder: "e.g., email, sms, slack_message" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">The format of the drafted content.</p>
        </div>

        <%# categories — llm_classify only %>
        <div data-controller="conditional-field"
             data-conditional-field-when-value="llm_classify"
             data-conditional-field-selector-value="select[name='step[step_type]']">
          <%= f.label :config_categories, "Categories", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_categories, value: @step.config_categories,
              class: field_classes,
              placeholder: "new_lead, existing_customer, spam, vendor" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Comma-separated list of classification categories.</p>
        </div>
      </div>
    </div>

    <%# Slack Notify %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="slack_notify"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Slack Notification</h3>
      <div class="space-y-4">
        <div>
          <%= f.label :config_channel, "Channel", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_channel, value: @step.config_channel,
              class: field_classes,
              placeholder: "#marketing" %>
        </div>
        <div>
          <%= f.label :config_message_template, "Message Template", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_area :config_message_template, value: @step.config_message_template, rows: 4,
              class: mono_classes,
              placeholder: "New lead from {{customer_name}}: {{subject}}" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Use <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">{{variable}}</code> for task context placeholders.</p>
        </div>
      </div>
    </div>

    <%# Slack Ask Human %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="slack_ask_human"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Slack Human Review</h3>
      <div class="space-y-4">
        <div>
          <%= f.label :config_channel, "Channel", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_channel, value: @step.config_channel,
              class: field_classes,
              placeholder: "#operations" %>
        </div>
        <div>
          <%= f.label :config_prompt, "Prompt", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_area :config_prompt, value: @step.config_prompt, rows: 4,
              class: mono_classes,
              placeholder: "Review this draft email for {{customer_name}}..." %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Use <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">{{variable}}</code> for task context placeholders.</p>
        </div>
        <div>
          <%= f.label :config_options, "Response Options", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_options, value: @step.config_options,
              class: field_classes,
              placeholder: "Send as-is, Edit first, Don't send" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Comma-separated list of options presented to the reviewer.</p>
        </div>
      </div>
    </div>

    <%# Query %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="query"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Query Configuration</h3>
      <div>
        <%= f.label :config_query_type, "Query Type", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
        <%= f.select :config_query_type,
            [['-- Select --', ''], ['CRM Search', 'crm_search'], ['CRM Customer Lookup', 'crm_customer'], ['Branch / Conditional', 'branch']],
            { selected: @step.config_query_type },
            { class: field_classes } %>
      </div>
    </div>

    <%# API Call %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="api_call"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">API Call Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :config_api, "API", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.select :config_api,
              [['-- Select --', ''], ['Email (SES)', 'email'], ['CRM', 'crm']],
              { selected: @step.config_api },
              { class: field_classes } %>
        </div>
        <div>
          <%= f.label :config_action, "Action", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_action, value: @step.config_action,
              class: field_classes,
              placeholder: "e.g., send_template, update_customer" %>
        </div>
      </div>
    </div>

    <%# Enqueue Next %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="enqueue_next"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Enqueue Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :config_sop_slug, "SOP Slug", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_sop_slug, value: @step.config_sop_slug,
              class: field_classes,
              placeholder: "e.g., follow-up-email" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">The slug of the SOP to enqueue.</p>
        </div>
        <div>
          <%= f.label :config_wait_duration, "Wait Duration (minutes)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.number_field :config_wait_duration, value: @step.config_wait_duration, min: 0,
              class: field_classes,
              placeholder: "0" %>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Delay before enqueuing (0 = immediately).</p>
        </div>
      </div>
    </div>

    <%# Wait %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6"
         data-controller="conditional-field"
         data-conditional-field-when-value="wait"
         data-conditional-field-selector-value="select[name='step[step_type]']">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Wait Configuration</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :config_duration_minutes, "Duration (minutes)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.number_field :config_duration_minutes, value: @step.config_duration_minutes, min: 1,
              class: field_classes,
              placeholder: "60" %>
        </div>
        <div>
          <%= f.label :config_follow_up_action, "Follow-up Action", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
          <%= f.text_field :config_follow_up_action, value: @step.config_follow_up_action,
              class: field_classes,
              placeholder: "e.g., check_status, send_reminder" %>
        </div>
      </div>
    </div>

    <%# Advanced Config (JSON) — collapsed fallback %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <details>
        <summary class="text-sm font-medium text-gray-900 dark:text-gray-100 cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          Advanced Config (JSON)
        </summary>
        <div class="mt-3">
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Additional configuration not covered by the fields above. Must be valid JSON.</p>
          <%= f.text_area :config,
              value: @step.advanced_config_json,
              rows: 6,
              class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-gray-100 font-mono text-sm focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400 dark:placeholder-gray-500",
              placeholder: "{\n  \"custom_key\": \"value\"\n}" %>
        </div>
      </details>
    </div>

    <%# Step Type Help %>
    <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Step Type Reference</h3>
      <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 text-sm space-y-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">query</code> - CRM API query / check condition</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">api_call</code> - Call external API (email, CRM, etc.)</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_classify</code> - Classify input into categories</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_draft</code> - Draft text content (email, message)</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_decide</code> - Make a judgment call with reasoning</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">llm_analyze</code> - Complex analysis of data/situation</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">slack_notify</code> - Post update to Slack channel</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">slack_ask_human</code> - Post to Slack and wait for response</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">enqueue_next</code> - Trigger another SOP or schedule follow-up</div>
          <div><code class="text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded">wait</code> - Pause for a duration before continuing</div>
        </div>
      </div>
    </div>
  </div>

  <%# Actions %>
  <div class="flex items-center justify-end gap-3">
    <%= link_to "Cancel", admin_sop_path(@sop),
        class: "px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 font-medium transition-colors" %>
    <%= f.submit @step.persisted? ? "Update Step" : "Create Step",
        class: "px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900" %>
  </div>
<% end %>
