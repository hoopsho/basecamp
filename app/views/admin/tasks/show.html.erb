<div class="space-y-6">
  <%# Back link and header %>
  <div class="flex items-center gap-4">
    <%= link_to admin_tasks_path, class: 'inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors' do %>
      <%= heroicon 'arrow-left', variant: :outline, class: 'w-4 h-4 mr-1' %>
      Back to Tasks
    <% end %>
  </div>

  <div class="flex flex-col lg:flex-row lg:items-start gap-6">
    <%# Left column: Task details %>
    <div class="flex-1 space-y-6">
      <%# Task header card %>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-6">
          <div>
            <div class="flex items-center gap-3 mb-2">
              <%= status_badge(@task.status) %>
              <span class="text-sm text-gray-500 dark:text-gray-400 font-mono"><%= @task.id.to_s.first(8) %></span>
            </div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
              <%= @task.sop&.name || 'Unknown SOP' %>
            </h1>
            <p class="mt-1 text-gray-600 dark:text-gray-400">
              <%= @task.agent&.name || 'Unknown Agent' %>
            </p>
          </div>

          <%# Action buttons %>
          <div class="flex flex-wrap items-center gap-2">
            <% if @task.failed? %>
              <%= button_to retry_admin_task_path(@task),
                            method: :post,
                            class: 'inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800' do %>
                <%= heroicon 'arrow-path', variant: :outline, class: 'w-5 h-5' %>
                Retry
              <% end %>
            <% end %>

            <% if @task.active? %>
              <%= button_to cancel_admin_task_path(@task),
                            method: :post,
                            class: 'inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800',
                            data: { turbo_confirm: 'Are you sure you want to cancel this task?' } do %>
                <%= heroicon 'x-circle', variant: :outline, class: 'w-5 h-5' %>
                Cancel
              <% end %>
            <% end %>

            <% if @task.slack_thread_ts.present? %>
              <%= link_to slack_thread_url(@task),
                          target: '_blank',
                          rel: 'noopener',
                          class: 'inline-flex items-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-lg transition-colors' do %>
                <%= heroicon 'chat-bubble-left-right', variant: :outline, class: 'w-5 h-5' %>
                View in Slack
              <% end %>
            <% end %>
          </div>
        </div>

        <%# Task metadata grid %>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
          <div>
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Current Step</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100">
              <%= @task.current_step_position || '—' %>
            </dd>
          </div>

          <div>
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Priority</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100">
              <%= priority_indicator(@task.priority) %>
            </dd>
          </div>

          <div>
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Created</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100">
              <%= @task.created_at.strftime('%b %d, %Y %H:%M') %>
            </dd>
          </div>

          <div>
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Duration</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100">
              <%= task_duration(@task) %>
            </dd>
          </div>
        </div>

        <% if @task.error_message.present? %>
          <div class="mt-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
            <div class="flex items-start gap-3">
              <%= heroicon 'exclamation-triangle', variant: :outline, class: 'w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5' %>
              <div>
                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3>
                <p class="mt-1 text-sm text-red-700 dark:text-red-300"><%= @task.error_message %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <%# Context data %>
      <% if @task.context.present? %>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden" data-controller="toggle">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
              <%= heroicon 'document-text', variant: :outline, class: 'w-5 h-5 text-gray-400 dark:text-gray-500' %>
              Context Data
            </h2>
            <button type="button"
                    data-action="click->toggle#toggle"
                    data-toggle-target="button"
                    class="text-sm text-primary-600 dark:text-primary-400 hover:underline focus:outline-none">
              Toggle
            </button>
          </div>
          <div data-toggle-target="content" class="hidden">
            <div class="p-6">
              <% if @task.context.is_a?(Hash) %>
                <dl class="space-y-4">
                  <% @task.context.each do |key, value| %>
                    <div>
                      <dt class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= key %></dt>
                      <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100">
                        <% if value.is_a?(Hash) || value.is_a?(Array) %>
                          <pre class="p-3 bg-gray-50 dark:bg-gray-900 rounded-lg overflow-x-auto text-xs font-mono text-gray-700 dark:text-gray-300"><%= JSON.pretty_generate(value) %></pre>
                        <% else %>
                          <%= value %>
                        <% end %>
                      </dd>
                    </div>
                  <% end %>
                </dl>
              <% else %>
                <pre class="p-3 bg-gray-50 dark:bg-gray-900 rounded-lg overflow-x-auto text-xs font-mono text-gray-700 dark:text-gray-300"><%= JSON.pretty_generate(@task.context) %></pre>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Event timeline %>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
            <%= heroicon 'clock', variant: :outline, class: 'w-5 h-5 text-gray-400 dark:text-gray-500' %>
            Event Timeline
          </h2>
        </div>

        <% if @task_events.present? %>
          <div class="p-6">
            <div class="flow-root">
              <ul role="list" class="-mb-8">
                <% @task_events.each_with_index do |event, index| %>
                  <%= render 'event', event: event, last: index == @task_events.size - 1 %>
                <% end %>
              </ul>
            </div>
          </div>
        <% else %>
          <div class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
            <%= heroicon 'inbox', variant: :outline, class: 'w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600' %>
            <p>No events recorded yet.</p>
          </div>
        <% end %>
      </div>
    </div>

    <%# Right sidebar: Related info %>
    <div class="w-full lg:w-80 space-y-6">
      <%# SOP info %>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">SOP Details</h3>
        <dl class="space-y-3">
          <div>
            <dt class="text-xs text-gray-500 dark:text-gray-400">Name</dt>
            <dd class="text-sm text-gray-900 dark:text-gray-100">
              <%= link_to @task.sop&.name || 'Unknown', admin_sop_path(@task.sop), class: 'text-primary-600 dark:text-primary-400 hover:underline' if @task.sop %>
            </dd>
          </div>
          <div>
            <dt class="text-xs text-gray-500 dark:text-gray-400">Trigger Type</dt>
            <dd class="text-sm text-gray-900 dark:text-gray-100"><%= @task.sop&.trigger_type&.humanize || '—' %></dd>
          </div>
          <div>
            <dt class="text-xs text-gray-500 dark:text-gray-400">Max Tier</dt>
            <dd class="text-sm text-gray-900 dark:text-gray-100">Tier <%= @task.sop&.max_tier || '—' %></dd>
          </div>
        </dl>
      </div>

      <%# Agent info %>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">Agent Details</h3>
        <dl class="space-y-3">
          <div>
            <dt class="text-xs text-gray-500 dark:text-gray-400">Name</dt>
            <dd class="text-sm text-gray-900 dark:text-gray-100">
              <%= link_to @task.agent&.name || 'Unknown', admin_agent_path(@task.agent), class: 'text-primary-600 dark:text-primary-400 hover:underline' if @task.agent %>
            </dd>
          </div>
          <div>
            <dt class="text-xs text-gray-500 dark:text-gray-400">Status</dt>
            <dd class="text-sm text-gray-900 dark:text-gray-100"><%= @task.agent&.status&.humanize || '—' %></dd>
          </div>
          <div>
            <dt class="text-xs text-gray-500 dark:text-gray-400">Slack Channel</dt>
            <dd class="text-sm text-gray-900 dark:text-gray-100"><%= @task.agent&.slack_channel || '—' %></dd>
          </div>
        </dl>
      </div>

      <%# Parent task (if sub-task) %>
      <% if @task.parent_task %>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">Parent Task</h3>
          <%= link_to admin_task_path(@task.parent_task), class: 'block p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors' do %>
            <div class="flex items-center gap-2 mb-1">
              <%= status_badge(@task.parent_task.status) %>
            </div>
            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
              <%= @task.parent_task.sop&.name || 'Unknown SOP' %>
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400 font-mono mt-1">
              <%= @task.parent_task.id.to_s.first(8) %>
            </p>
          <% end %>
        </div>
      <% end %>

      <%# Sub-tasks %>
      <% if @task.sub_tasks.present? %>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">
            Sub-tasks (<%= @task.sub_tasks.count %>)
          </h3>
          <ul class="space-y-2">
            <% @task.sub_tasks.each do |sub_task| %>
              <li>
                <%= link_to admin_task_path(sub_task), class: 'block p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors' do %>
                  <div class="flex items-center gap-2 mb-1">
                    <%= status_badge(sub_task.status) %>
                  </div>
                  <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                    <%= sub_task.sop&.name || 'Unknown SOP' %>
                  </p>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%#
  Helper methods expected:

  def task_duration(task)
    return '—' unless task.started_at

    end_time = task.completed_at || Time.current
    duration = end_time - task.started_at

    if duration < 60
      "#{duration.round}s"
    elsif duration < 3600
      "#{(duration / 60).round}m"
    else
      "#{(duration / 3600).round(1)}h"
    end
  end

  def slack_thread_url(task)
    # Returns Slack URL for the thread
    "https://slack.com/app_redirect?channel=#{task.agent&.slack_channel}&thread_ts=#{task.slack_thread_ts}"
  end
%>
